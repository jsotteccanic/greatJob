<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Great Job!</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">
    <link rel="manifest" href="./manifest.json">
    <!-- Link Swiper's CSS -->
    <link rel="stylesheet" href="./css/semantic.min.css">
    <link rel="stylesheet" href="./css/swiper.css">
    <script src="./js/jquery-3.4.0.min.js"></script>
    <script src="./js/semantic.min.js"></script>
    <script src="https://dmla.github.io/jsqrcode/src/qr_packed.js"></script>

    <!-- metas y tag para PAW -->
    <link href="https://fonts.googleapis.com/css?family=Lobster" rel="stylesheet">
    <!-- Metas para el progresive web app -->
    <meta name="theme-color" content="#F7DF1E">
    <link rel="icon" type="image/png" sizes="72x72" href="./images/icons/icon-72x72.png">
    <link rel="icon" type="image/png" sizes="96x96" href="./images/icons/icon-96x96.png">
    <link rel="icon" type="image/png" sizes="128x128" href="./images/icons/icon-128x128.png">
    <link rel="icon" type="image/png" sizes="152x152" href="./images/icons/icon-152x152.png">
    <link rel="icon" type="image/png" sizes="192x192" href="./images/icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="384x384" href="./images/icons/icon-384x384.png">
    <link rel="icon" type="image/png" sizes="512x512" href="./images/icons/icon-512x512.png">

    <!-- metas para ios -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Add to Home">
    <link rel="shortcut icon" sizes="16x16" href="./images/icons/icon-192x192.png">
    <link rel="shortcut icon" sizes="196x196" href="./images/icons/icon-192x192.png">
    <link rel="apple-touch-icon-precomposed" href="./images/icons/icon-192x192.png">
    <!-- fin metas ios -->

    <style>
        h1,
        h2,
        a {
            font-family: 'Lobster', cursive;
        }

        body {
            background: #0575E6;
            /* fallback for old browsers */
            background: -webkit-linear-gradient(to right, #021B79, #0575E6);
            /* Chrome 10-25, Safari 5.1-6 */
            background: linear-gradient(to right, #021B79, #0575E6);
            /* W3C, IE 10+/ Edge, Firefox 16+, Chrome 26+, Opera 12+, Safari 7+ */


            font-size: 14px;
            color: white;
            margin: 0;
            padding: 0;
            padding-top: 5px;
        }

        .swiper-container {
            width: 100%;
            margin-top: 10px;
            padding-top: 0px;
            padding-bottom: 35px;
        }

        .swiper-slide {
            background-position: center;
            background-size: cover;
            width: 250px;
            height: 250px;
        }

        img {
            width: 250px;
            height: 250px;
        }

        h1 {
            text-align: center;
            margin-top: 100px;
            margin-bottom: 5px;
        }

        h2 {
            text-align: center;
            margin: 0;
            padding: 0;
        }

        .ui.icon.buttons {
            float: left;
        }

        a {
            float: right;
            text-decoration: none;
            color: white;
        }
    </style>

    <!-- addTohome -->
    <link rel="stylesheet" href="./css/addtohomescreen.css">
    <script src="./js/addtohomescreen.js"></script>
    <script>
        addToHomescreen();
    </script>
</head>

<body class="dimmable" onload="cargarDatosEnvío()">

    <!-- Swiper -->
    <div class="ui container">
        <a href="#" class="ui button mini inverted white circular" onclick="cerrarSession()">salir</a>
        <header>
            <h1>
                Selecciona una tarjeta
            </h1>
        </header>
        <div class="pusher left right">
            <div class="swiper-container">
                <div class="swiper-wrapper">
                    <div class="swiper-slide">
                        <div>
                            <!-- <img src="https://firebasestorage.googleapis.com/v0/b/appreconocimiento-ecaa9.appspot.com/o/Resilencia%2FA.jpg?alt=media&token=2ebdbccc-bc8f-4064-8751-4f76d4445ffd" -->
                            <img src="https://firebasestorage.googleapis.com/v0/b/appreconocimiento-ecaa9.appspot.com/o/Resilencia%2FAA.PNG?alt=media&token=ba053b11-f4e1-4ea2-b572-373892acac5f"
                                alt="">
                        </div>
                        <div>
                            <h2>resiliencia</h2>
                        </div>
                    </div>
                    <div class="swiper-slide">
                        <div>
                            <img src="https://firebasestorage.googleapis.com/v0/b/appreconocimiento-ecaa9.appspot.com/o/Resilencia%2FBB.png?alt=media&token=bba88ddb-0084-4c5f-b60a-bc4e4af077fc"
                                alt="">
                        </div>
                        <div>
                            <h2>Enfoque al cliente</h2>
                        </div>
                    </div>
                    <div class="swiper-slide">
                        <div>
                            <img src="https://firebasestorage.googleapis.com/v0/b/appreconocimiento-ecaa9.appspot.com/o/Resilencia%2FFF.png?alt=media&token=8351a0c4-8411-4048-bf66-7cef9bc2a61a"
                                alt="">
                        </div>
                        <div>
                            <h2>Genera confianza</h2>
                        </div>
                    </div>
                    <div class="swiper-slide">
                        <div>
                            <img src="https://firebasestorage.googleapis.com/v0/b/appreconocimiento-ecaa9.appspot.com/o/Resilencia%2FEE.png?alt=media&token=89e5aed9-f455-48a0-aa18-db6f1d3c802d"
                                alt="">
                        </div>
                        <div>
                            <h2>Genera confianza</h2>
                        </div>
                    </div>
                    <div class="swiper-slide">
                        <div>
                            <img src="https://firebasestorage.googleapis.com/v0/b/appreconocimiento-ecaa9.appspot.com/o/Resilencia%2FDD.png?alt=media&token=7cd7292c-78a2-493b-895f-4a676e7454f7"
                                alt="">
                        </div>
                        <div>
                            <h2>Obtiene resultados</h2>
                        </div>
                    </div>
                    <div class="swiper-slide">
                        <div>
                            <img src="https://firebasestorage.googleapis.com/v0/b/appreconocimiento-ecaa9.appspot.com/o/Resilencia%2FGG.png?alt=media&token=c7e7759a-ca7e-4b90-a612-152c9b4844cf"
                                alt="">
                        </div>
                        <div>
                            <h2>Auto desarrollo</h2>
                        </div>
                    </div>
                    <div class="swiper-slide">
                        <div>
                            <img src="https://firebasestorage.googleapis.com/v0/b/appreconocimiento-ecaa9.appspot.com/o/Resilencia%2FHH.png?alt=media&token=7af4468a-cd64-4102-9432-26a1469c6e2e"
                                alt="">
                        </div>
                        <div>
                            <h2>Solución Creativa!</h2>
                        </div>
                    </div>
                </div>
                <!-- Add Pagination -->
                <div class="swiper-pagination"></div>
            </div>
        </div>
        <div id="enviarForm" class="ui basic mini modal">
            <div class="header">
                <h1>Enviar mensaje </h1>
            </div><i class="close icon"></i>
            <div class="content">
                <div class="ui inverted segment">
                    <form class="ui form inverted">
                        <div class="field">
                            <label id="destinatario"></label>
                        </div>
                        <input id="readQR" type="file" accept="image/*" capture="environment"
                            onchange="openQRCamera(this);" hidden="">
                        <div class="field">
                            <label>Mensaje (Opcional)</label>
                            <textarea name="" id="mensaje" cols="30" rows="5"></textarea>
                        </div>
                        <button class="ui button fluid inverted green" onclick="enviarCorreo(event)">Enviar</button>
                    </form>
                </div>
            </div>
        </div>
        <!-- login -->
        <div id="loginForm" class="ui basic mini modal">
            <div class="content">
                <div class="header">
                    <div class="ui inverted segment">
                        <img class="ui centered right small image" src="./images/LEAD-mini.png">
                        <hr>
                        <form class="ui form inverted">
                            <div class="field">
                                <input type="text" id="user" placeholder="correo@electronico.com">
                            </div>
                            <div class="field">
                                <input type="password" id="pw" placeholder="contraseña">
                            </div>
                            <button class="ui button fluid inverted green"
                                onclick="iniciarSession(event)">Enviar</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <!-- Swiper JS -->
        <script src="./js/swiper.js"></script>
        <script src="https://www.gstatic.com/firebasejs/5.9.4/firebase.js"></script>
        <script>
            // Initialize Firebase
            var config = {
                apiKey: "AIzaSyAffvS0jx68q_FP4oesLHdvBO3z71eLX0s",
                authDomain: "appreconocimiento-ecaa9.firebaseapp.com",
                databaseURL: "https://appreconocimiento-ecaa9.firebaseio.com",
                projectId: "appreconocimiento-ecaa9",
                storageBucket: "appreconocimiento-ecaa9.appspot.com",
                messagingSenderId: "618096000912"
            };
            firebase.initializeApp(config);
        </script>
        <!-- Initialize Swiper -->
        <script>
            var swiper = new Swiper('.swiper-container', {
                effect: 'coverflow',
                grabCursor: true,
                centeredSlides: true,
                slidesPerView: 'auto',
                coverflowEffect: {
                    rotate: 50,
                    stretch: 0,
                    depth: 100,
                    modifier: 4,
                    slideShadows: true,
                }
            });
        </script>

        <script>
            var url_string
            var url
            var nombreDestinatario
            var correoDestinatario
            let user = document.getElementById("user");
            let pw = document.getElementById("pw");
            let divs = document.querySelectorAll(".swiper-slide div img");
            let readQR = document.getElementById("readQR");
            let destinatario = document.getElementById("destinatario");
            let mensaje = document.getElementById("mensaje");
            let tipoReconocimiento = null;
            let imgUrl = null;
            let dataQr = null;
            let userMail = null;
            //Validar sesión
            firebase.auth().onAuthStateChanged(function (user) {
                if (user) {
                    userMail = user.email;
                    $('#loginForm').modal('hide');
                    user.value = "";
                    pw.value = "";
                } else {
                    $('#loginForm').modal('setting', 'closable', false).modal('show');
                    user.value = "";
                    pw.value = "";
                }
            });
            //asignando evento a los divs con imagenes
            divs.forEach(div => {
                div.addEventListener("click", e => {
                    // let msj = confirm("¿Desea enviar esta tarjeta?");
                    // if (msj) {
                        tipoReconocimiento = e.target.parentElement.parentElement.children[1].innerText;
                        imgUrl = e.target.src;
                        destinatario.innerHTML = nombreDestinatario;
                        mensaje.value = "";
                        // readQR.click();
                        $('#enviarForm').modal('show');
                    // }
                })
            });
            //Lógica del programa
            function iniciarSession(e) {
                e.preventDefault();
                firebase
                    .auth()
                    .signInWithEmailAndPassword(user.value, pw.value)
                    .catch(function (error) {
                        if (error) {
                            alert(error.message);
                            user.value = "";
                            pw.value = "";
                        } else {
                            $('#loginForm').modal('hide');
                            user.value = "";
                            pw.value = "";
                        }
                    });
            }
            function cerrarSession() {
                firebase.auth().signOut().then(function () {
                    user.value = "";
                    pw.value = "";
                }).catch(function (error) {
                    alert(error)
                });
            }

            // function openQRCamera(node) {
            //     var reader = new FileReader();
            //     reader.onload = function () {
            //         node.value = "";
            //         qrcode.callback = function (res) {
            //             if (res instanceof Error) {
            //                 console.log("No QR code found. Please make sure the QR code is within the camera's frame and try again.");
            //                 readQR.click();
            //             } else {
            //                 res = JSON.parse(res);
            //                 if (res.nombre != undefined) {
            //                     dataQr = res.correo;
            //                     destinatario.innerHTML = `destinatario : ${res.nombre}`;
            //                 } else {
            //                     destinatario.innerHTML = "";
            //                     readQR.click();
            //                 }

            //             }
            //         };
            //         qrcode.decode(reader.result);
            //     };
            //     reader.readAsDataURL(node.files[0]);
            // }
            function enviarCorreo(e) {
                e.preventDefault();
                let data = {
                    destino: correoDestinatario||dataQr,
                    tipo: tipoReconocimiento,
                    mensaje: mensaje.value,
                    url: imgUrl
                }
                console.log(data);
                fetch('https://us-central1-appreconocimiento-ecaa9.cloudfunctions.net/helloWorld', {
                    method: 'POST',
                    body: JSON.stringify(data),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(x => x.text())
                    .then(x => {
                        console.log(x);
                        alert(x);
                        imgUrl = null;
                        dataQr = null;
                        correoDestinatario = null;
                        mensaje = null;
                        tipo = null;
                        $('#enviarForm').modal('hide');
                    })
                    .catch(err => { console.log(err); alert(err); });
            }
            function cargarDatosEnvío() {
                url_string = window.location;
                url = new URL(url_string);
                nombreDestinatario = url.searchParams.get("nombre");
                correoDestinatario = url.searchParams.get("correo");
                

                console.log(nombre, correo);
            }
        </script>
    </div>
</body>

</html>